<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Certificado de Afiliaci√≥n</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <style>
    body {
      font-family: Tahoma, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .formulario {
      background: white;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      margin: 30px auto 20px;
      text-align: center;
      max-width: 400px;
      width: 100%;
    }

    .formulario input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }

    .formulario button {
      background-color: #005baa;
      color: white;
      border: none;
      padding: 10px 20px;
      margin-top: 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .botones-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 20px auto;
      max-width: 800px;
    }

    .botones-container button {
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      color: white;
      min-width: 180px;
    }

    #boton-descarga { background-color: #28a745; }
    #boton-pdf { background-color: #dc3545; }
    #boton-whatsapp { background-color: #25D366; }
    #boton-email { background-color: #17a2b8; }
    #boton-volver { background-color: #6c757d; }

    #contenido-certificado {
      width: 210mm;
      min-height: 260mm;
      margin: 20px auto;
      padding: 10mm 20mm;
      background-image: url('https://raw.githubusercontent.com/carlos2601/certificados-afiliacion/main/logo.jpg');
      background-position: center 20%;
      background-repeat: no-repeat;
      background-size: 90%;
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      box-sizing: border-box;
      position: relative;
    }

    .encabezado-certificado {
      text-align: center;
      font-size: 17px;
      line-height: 1.4;
      margin-bottom: 20px;
      margin-top: 0;
    }

    .texto-justificado {
      text-align: justify;
      font-size: 9px;
      line-height: 1.5;
      margin: 0px 0;
    }

    .titulo-certificado {
      text-align: center;
      font-size: 18px;
      line-height: 1.5;
      margin: 30px 0;
    }

    .datos-certificado {
      text-align: left;
      font-size: 16px;
      line-height: 1.6;
      margin: 20px 0;
    }

    .firma-fondo {
      width: 270px;
      position: absolute;
      bottom: 25mm;
      left: 50%;
      transform: translateX(-50%);
    }
    
    .sello-derecha {
      width: 140px;
      position: absolute;
      bottom: 55mm;
      right: 20mm;
    }

    .sello2-fondo {
      width: 180px;
      position: absolute;
      bottom: 45mm;
      left: 50%;
      transform: translateX(-50%);
    }

    .pie-certificado {
      position: absolute;
      bottom: 20mm;
      width: calc(100% - 40mm);
      text-align: center;
      font-size: 12px;
    }

    #cedula {
      background-color: #e3f2fd;
      font-weight: bold;
      border: 2px solid #2196f3;
    }

    .whatsapp-control, .email-control {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin: 15px auto;
      display: none;
      max-width: 400px;
      width: 100%;
      text-align: center;
      position: relative;
    }
    
    .whatsapp-control .cerrar, .email-control .cerrar {
      position: absolute;
      top: 5px;
      right: 10px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #666;
    }
    
    #numero-whatsapp, #email-destino {
      width: 90%;
      padding: 10px 12px;
      margin: 8px 0;
      border-radius: 6px;
      font-size: 14px;
    }
    
    #numero-whatsapp {
      border: 2px solid #25D366;
      background-color: #f0fff4;
    }
    
    #email-destino {
      border: 2px solid #17a2b8;
      background-color: #f0f8ff;
    }
    
    #confirmar-whatsapp, #confirmar-email {
      color: white;
      border: none;
      padding: 10px 20px;
      margin-top: 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      width: 100%;
    }
    
    #confirmar-whatsapp {
      background-color: #25D366;
    }
    
    #confirmar-email {
      background-color: #17a2b8;
    }
    
    .whatsapp-info, .email-info {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    
    .error-message {
      color: #dc3545;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }
  </style>
</head>
<body>

  <form id="formulario" class="formulario">
    <h2>Buscar documento</h2>
    <input type="text" id="cedula" placeholder="N√∫mero de c√©dula o Nombre" required />
    <input type="text" id="nombre-editable" placeholder="Nombre completo" style="display:none;" />
    <input type="text" id="cedula-editable" placeholder="C√©dula" style="display:none;" />
    <input type="text" id="fecha-editable" placeholder="Fecha de afiliaci√≥n" style="display:none;" />
    <input type="text" id="registro-editable" placeholder="Registro N¬∫" style="display:none;" />
    <input type="text" id="folio-editable" placeholder="Folio N¬∫" style="display:none;" />
    <input type="text" id="renglon-editable" placeholder="Rengl√≥n N¬∫" style="display:none;" />
    <input type="text" id="direccion-editable" placeholder="Direcci√≥n" style="display:none;" />
    <button type="submit">Consultar</button>
  </form>

  <div class="botones-container">
    <button id="boton-descarga" style="display:none;">Descargar Imagen (PNG)</button>
    <button id="boton-pdf" style="display:none;">Descargar PDF</button>
    <button id="boton-whatsapp" style="display:none;">Enviar por WhatsApp</button>
    <button id="boton-email" style="display:none;">Enviar por Email</button>
    <button id="boton-volver" onclick="window.location.href='panelprincipal.html'">Volver al Panel</button>
  </div>

  <div class="whatsapp-control" id="whatsapp-control">
    <button class="cerrar" onclick="document.getElementById('whatsapp-control').style.display='none'">√ó</button>
    <h3>Enviar por WhatsApp</h3>
    <input type="text" id="numero-whatsapp" placeholder="N√∫mero de celular (10 d√≠gitos)" maxlength="10" />
    <div class="error-message" id="whatsapp-error">Ingrese un n√∫mero v√°lido de 10 d√≠gitos</div>
    <div class="whatsapp-info">Solo n√∫meros colombianos. Ejemplo: 3123456789</div>
    <button id="confirmar-whatsapp">Enviar Certificado</button>
  </div>

  <div class="email-control" id="email-control">
    <button class="cerrar" onclick="document.getElementById('email-control').style.display='none'">√ó</button>
    <h3>Enviar por Correo Electr√≥nico</h3>
    <input type="email" id="email-destino" placeholder="Correo electr√≥nico del destinatario" required />
    <div class="error-message" id="email-error">Ingrese un correo electr√≥nico v√°lido</div>
    <button id="confirmar-email">Enviar Certificado</button>
  </div>

  <div id="contenido-certificado" style="display:none;">
    <div class="encabezado-certificado">
      <br>
      <strong>REPUBLICA DE COLOMBIA</strong><br>
      <strong>DEPARTAMENTO DEL META</strong><br>
      <strong>PUERTO GAIT√ÅN ‚Äì META</strong><br>
      <strong>JUNTA DE ACCI√ìN COMUNAL</strong><br>
      <strong>ASENTAMIENTO HUMANO BATEAS</strong><br>
      Personer√≠a Jur√≠dica No. 101 del 20 de noviembre de 2.012.
    </div>
    <div class="texto-justificado">
      El suscrito presidente del asentamiento humano Bateas, del Municipio de Puerto Gait√°n Meta, fundamentado en la ley 1551 del 2012 que modifica el art√≠culo 91 de la ley 136 de 1994, el cual reza en su art√≠culo 91: Funciones. Los Alcaldes ejercer√°n‚Ä¶y adem√°s de estas, en el literal F numeral 6. Con relaci√≥n a la prosperidad integral de su regi√≥n; Expedir√° la certificaci√≥n para acreditar la residencia a aquellas personas que residen  en el territorio del √°rea de influencia de los proyectos de exploraci√≥n y explotaci√≥n petrolera y miner√≠a en general, y que aspiren acceder a labores como mano de  obra no calificada y calificada, Los alcaldes expedir√°n dichos certificados con base en LOS REGISTROS ELECTORALES O DE SISBEN , ASI COMO LOS REGISTROS DE LOS AFILIADOS DE LAS JUNTAS DE ACCI√ìN COMUNAL
    </div>

    <div class="titulo-certificado">
      <span style="font-size:18px;">CONSTANCIA DE AFILIACI√ìN</span><br>
      <strong>La Junta de Acci√≥n Comunal del Barrio Bateas</strong><br>
      HACE CONSTAR:<br>
      Que la informaci√≥n suministrada reposa en el libro de afiliados:
    </div>

    <div class="datos-certificado">
      NOMBRE: <strong id="nombre-cert"></strong><br>
      C√âDULA: <strong id="cedula-cert"></strong><br>
      FECHA DE AFILIACI√ìN: <strong id="fecha-cert"></strong><br>
      REGISTRO N¬∫: <strong id="registro-cert"></strong><br>
      FOLIO N¬∫: <strong id="folio-cert"></strong><br>
      RENGL√ìN N¬∫: <strong id="renglon-cert"></strong><br>
      DIRECCI√ìN: <strong id="direccion-cert"></strong><br><br>
      La presente constancia se expide a solicitud del interesado, <strong id="fecha-emision"></strong> y tiene vigencia de 6 meses a partir de la fecha de su expedici√≥n.
    </div>
    <br>Atentamente,<br><br><br><br>

    <img src="https://raw.githubusercontent.com/carlos2601/certificados-afiliacion/main/sello.png" class="sello-derecha" alt="Sello">
    <img src="https://raw.githubusercontent.com/carlos2601/certificados-afiliacion/main/firma.png" class="firma-fondo" alt="Firma">
    <img src="https://raw.githubusercontent.com/carlos2601/certificados-afiliacion/main/sello2.png" class="sello2-fondo" alt="Sello">

    <div style="text-align:center;margin-top:30px;">
      __________________________<br>
      <strong>JUAN CARLOS USECHE B</strong><br>
      Presidente<br>
      jacbateasgaitan@gmail.com
    </div>
    <br><br>
    <div style="text-align:justify;font-size:12px;line-height:1.3;margin-top:25px;"><br><br>
      C√≥digo penal colombiano. "ley 599 de 2000 art. 287.falsedad material en documento p√∫blico, el que falsifique documentos p√∫blicos que pueda servir de prueba, incurrir√° en prisi√≥n de 3 a 6 a√±os". 
    </div>
  </div>

<script>
  // Configuraci√≥n Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCERQc8srBtLuMe6Jw944WsO1mySohMpkU",
    authDomain: "junta-bateas-sector-3.firebaseapp.com",
    projectId: "junta-bateas-sector-3",
    storageBucket: "junta-bateas-sector-3.appspot.com",
    messagingSenderId: "913958453084",
    appId: "1:913958453084:web:5324de6958dfff01980b99"
  };

  // Inicializar Firebase
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  const storage = firebase.storage();
  const { jsPDF } = window.jspdf;

  // Inicializar EmailJS
  emailjs.init('TU_USER_ID_DE_EMAILJS'); // Reemplaza con tu User ID

  // Variables globales
  let personaEncontrada = null;

  // Funci√≥n para formatear c√©dula
  function formatearCedula(cedula) {
    if (!cedula) return '';
    return cedula.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  // Funci√≥n para formatear fecha
  function formatearFecha(fecha) {
    if (!fecha) return '';
    const date = new Date(fecha);
    if (isNaN(date)) return fecha;
    return date.toLocaleDateString('es-CO');
  }

  // Cargar datos desde Firebase
  function cargarDatos() {
    return new Promise((resolve, reject) => {
      database.ref('afiliaciones').once('value')
        .then((snapshot) => {
          const data = snapshot.val();
          resolve(data ? Object.values(data) : []);
        })
        .catch(reject);
    });
  }

  // Mostrar certificado
  function mostrarCertificado(persona) {
    document.getElementById("nombre-cert").textContent = persona.nombre;
    document.getElementById("cedula-cert").textContent = formatearCedula(persona.cedula);
    document.getElementById("fecha-cert").textContent = formatearFecha(persona.fecha);
    document.getElementById("registro-cert").textContent = formatearCedula(persona.registro);
    document.getElementById("folio-cert").textContent = persona.folio;
    document.getElementById("renglon-cert").textContent = persona.renglon;
    document.getElementById("direccion-cert").textContent = persona.direccion;
    document.getElementById("fecha-emision").textContent = formatearFecha(new Date());
    
    document.getElementById("contenido-certificado").style.display = 'block';
    document.getElementById("boton-descarga").style.display = 'block';
    document.getElementById("boton-pdf").style.display = 'block';
    document.getElementById("boton-whatsapp").style.display = 'block';
    document.getElementById("boton-email").style.display = 'block';
  }

  // Buscar persona
  document.getElementById("formulario").addEventListener("submit", async function(e) {
    e.preventDefault();
    const cedula = document.getElementById("cedula").value.trim();
    
    try {
      const baseDatos = await cargarDatos();
      const persona = baseDatos.find(p => 
        String(p.cedula).replace(/\D/g, '') === cedula.replace(/\D/g, '') || 
        p.nombre.toLowerCase().includes(cedula.toLowerCase())
      );

      if (!persona) throw new Error("No se encontr√≥ el documento");
      
      personaEncontrada = persona;
      mostrarCertificado(persona);
    } catch (error) {
      alert(error.message);
    }
  });

  // Capturar certificado (optimizado para PDF y PNG)
  async function capturarCertificado(formato = 'png') {
    const elemento = document.getElementById("contenido-certificado");
    const options = {
      scale: formato === 'pdf' ? 2 : 2, // Mayor escala para PDF
      logging: true,
      useCORS: true,
      allowTaint: true,
      backgroundColor: '#FFFFFF',
      scrollX: 0,
      scrollY: 0
    };
    
    return await html2canvas(elemento, options);
  }

  // Descargar PNG (optimizado)
  document.getElementById("boton-descarga").addEventListener("click", async function() {
    try {
      const canvas = await capturarCertificado('png');
      // Reducir calidad para PNG (85% como balance)
      const link = document.createElement('a');
      link.href = canvas.toDataURL('image/png', 0.85);
      link.download = `certificado_${personaEncontrada.cedula}.png`;
      link.click();
    } catch (error) {
      alert("Error al generar la imagen");
    }
  });

  // Descargar PDF (optimizado)
  document.getElementById("boton-pdf").addEventListener("click", async function() {
    try {
      const canvas = await capturarCertificado('pdf');
      const pdf = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
      });

      // Optimizaci√≥n para PDF
      const imgData = canvas.toDataURL('image/jpeg', 0.85); // Usar JPEG para PDF con 85% calidad
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

      pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
      pdf.save(`certificado_${personaEncontrada.cedula}.pdf`);
    } catch (error) {
      alert("Error al generar el PDF");
    }
  });

  // Validar n√∫mero de WhatsApp
  function validarNumeroWhatsApp(numero) {
    const soloNumeros = numero.replace(/\D/g, '');
    return soloNumeros.length === 10 && /^3[0-9]{9}$/.test(soloNumeros);
  }

  // Mostrar/ocultar error de WhatsApp
  document.getElementById("numero-whatsapp").addEventListener("input", function() {
    const numero = this.value;
    const errorElement = document.getElementById("whatsapp-error");
    
    if (numero && !validarNumeroWhatsApp(numero)) {
      errorElement.style.display = 'block';
    } else {
      errorElement.style.display = 'none';
    }
  });

  // Enviar por WhatsApp (versi√≥n mejorada)
  document.getElementById("boton-whatsapp").addEventListener("click", function() {
    document.getElementById("whatsapp-control").style.display = 'block';
  });

  document.getElementById("confirmar-whatsapp").addEventListener("click", async function() {
    const numeroInput = document.getElementById("numero-whatsapp");
    const numero = numeroInput.value.trim();
    
    if (!validarNumeroWhatsApp(numero)) {
      document.getElementById("whatsapp-error").style.display = 'block';
      numeroInput.focus();
      return;
    }
    
    try {
      alert("Preparando certificado para WhatsApp...");
      const canvas = await capturarCertificado('png');
      
      // 1. Subir a Firebase Storage
      const blob = await new Promise(resolve => {
        canvas.toBlob(resolve, 'image/png', 0.85); // 85% calidad
      });
      
      const nombreArchivo = `certificados/${personaEncontrada.cedula}_${Date.now()}.png`;
      const fileRef = storage.ref().child(nombreArchivo);
      await fileRef.put(blob);
      const urlDescarga = await fileRef.getDownloadURL();
      
      // 2. Formatear n√∫mero y mensaje
      const numeroWhatsApp = `57${numero.replace(/\D/g, '')}`;
      const mensaje = `*Certificado de Afiliaci√≥n* üèõÔ∏è\n\n` +
                     `*Nombre:* ${personaEncontrada.nombre}\n` +
                     `*C√©dula:* ${formatearCedula(personaEncontrada.cedula)}\n\n` +
                     `Descargar certificado: ${urlDescarga}\n\n` +
                     `_Este enlace estar√° disponible por 24 horas_`;
      
      // 3. Abrir WhatsApp
      window.open(`https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(mensaje)}`, '_blank');
      
      // 4. Limpiar y ocultar
      document.getElementById("whatsapp-control").style.display = 'none';
      numeroInput.value = '';
      
    } catch (error) {
      console.error("Error en WhatsApp:", error);
      alert("Ocurri√≥ un error. Por favor intente nuevamente.");
    }
  });

  // Validar email
  function validarEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  // Mostrar/ocultar error de email
  document.getElementById("email-destino").addEventListener("input", function() {
    const email = this.value;
    const errorElement = document.getElementById("email-error");
    
    if (email && !validarEmail(email)) {
      errorElement.style.display = 'block';
    } else {
      errorElement.style.display = 'none';
    }
  });

  // Enviar por Email
  document.getElementById("boton-email").addEventListener("click", function() {
    document.getElementById("email-control").style.display = 'block';
  });

  document.getElementById("confirmar-email").addEventListener("click", async function() {
    const email = document.getElementById("email-destino").value.trim();
    
    if (!validarEmail(email)) {
      document.getElementById("email-error").style.display = 'block';
      document.getElementById("email-destino").focus();
      return;
    }
    
    try {
      alert("Generando y enviando certificado por email...");
      const canvas = await capturarCertificado('pdf');
      
      // 1. Convertir a blob
      const blob = await new Promise(resolve => {
        canvas.toBlob(resolve, 'image/jpeg', 0.85); // 85% calidad para email
      });
      
      // 2. Subir a Firebase Storage temporalmente
      const nombreArchivo = `certificados/${personaEncontrada.cedula}_${Date.now()}.jpg`;
      const fileRef = storage.ref().child(nombreArchivo);
      await fileRef.put(blob);
      const urlDescarga = await fileRef.getDownloadURL();
      
      // 3. Configurar par√°metros para EmailJS
      const templateParams = {
        to_email: email,
        nombre: personaEncontrada.nombre,
        cedula: formatearCedula(personaEncontrada.cedula),
        fecha: formatearFecha(new Date()),
        enlace_certificado: urlDescarga
      };
      
      // 4. Enviar email (configura SERVICE_ID y TEMPLATE_ID en EmailJS)
      await emailjs.send('default_service', 'template_certificado', templateParams);
      
      alert(`Certificado enviado exitosamente a ${email}`);
      document.getElementById("email-control").style.display = 'none';
      document.getElementById("email-destino").value = '';
      
    } catch (error) {
      console.error("Error al enviar email:", error);
      alert("Ocurri√≥ un error al enviar el correo. Por favor intente nuevamente.");
    }
  });

  // Edici√≥n de campos
  ["nombre", "cedula", "fecha", "registro", "folio", "renglon", "direccion"].forEach(id => {
    const editable = document.getElementById(`${id}-editable`);
    if (editable) {
      editable.addEventListener("input", function() {
        const campo = document.getElementById(`${id}-cert`);
        if (campo) campo.textContent = this.value;
      });
    }
  });
</script>
</body>
</html>